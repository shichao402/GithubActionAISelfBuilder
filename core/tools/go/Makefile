.PHONY: build install test clean run help

# å˜é‡
BINARY_NAME=gh-action-debug
VERSION?=1.0.0
BUILD_DIR=dist
CMD_DIR=./cmd/gh-action-debug

# Go æ„å»ºå‚æ•°
LDFLAGS=-ldflags "-X main.Version=$(VERSION)"

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

## build: æ„å»ºå½“å‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
build:
	@echo "ğŸ”¨ æ„å»º $(BINARY_NAME)..."
	@mkdir -p $(BUILD_DIR)
	go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) $(CMD_DIR)
	@echo "âœ… æ„å»ºå®Œæˆ: $(BUILD_DIR)/$(BINARY_NAME)"

## build-all: æ„å»ºæ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
build-all:
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°..."
	@mkdir -p $(BUILD_DIR)
	
	@echo "  ğŸ“¦ Linux AMD64..."
	GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-linux-amd64 $(CMD_DIR)
	
	@echo "  ğŸ“¦ Linux ARM64..."
	GOOS=linux GOARCH=arm64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-linux-arm64 $(CMD_DIR)
	
	@echo "  ğŸ“¦ macOS AMD64..."
	GOOS=darwin GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-darwin-amd64 $(CMD_DIR)
	
	@echo "  ğŸ“¦ macOS ARM64 (M1/M2)..."
	GOOS=darwin GOARCH=arm64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-darwin-arm64 $(CMD_DIR)
	
	@echo "  ğŸ“¦ Windows AMD64..."
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-windows-amd64.exe $(CMD_DIR)
	
	@echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆï¼"
	@ls -lh $(BUILD_DIR)

## install: å®‰è£…åˆ°æœ¬åœ°
install:
	@echo "ğŸ“¦ å®‰è£… $(BINARY_NAME)..."
	go install $(LDFLAGS) $(CMD_DIR)
	@echo "âœ… å®‰è£…å®Œæˆ: $(shell go env GOPATH)/bin/$(BINARY_NAME)"

## test: è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test -v ./...

## test-coverage: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-coverage:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•ï¼ˆå«è¦†ç›–ç‡ï¼‰..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Š: coverage.html"

## run: è¿è¡Œç¨‹åºï¼ˆå¼€å‘æ¨¡å¼ï¼‰
run:
	@echo "ğŸš€ è¿è¡Œ $(BINARY_NAME)..."
	go run $(CMD_DIR) $(ARGS)

## clean: æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "ğŸ§¹ æ¸…ç†..."
	rm -rf $(BUILD_DIR)
	rm -f coverage.out coverage.html
	@echo "âœ… æ¸…ç†å®Œæˆ"

## fmt: æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

## lint: ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	golangci-lint run ./...

## deps: ä¸‹è½½ä¾èµ–
deps:
	@echo "ğŸ“¥ ä¸‹è½½ä¾èµ–..."
	go mod download
	go mod tidy
	@echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

## help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "å¯ç”¨çš„ make å‘½ä»¤:"
	@echo ""
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' | sed -e 's/^/ /'

# å¿«æ·æ–¹å¼
b: build
ba: build-all
i: install
t: test
r: run
c: clean


