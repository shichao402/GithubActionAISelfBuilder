---
alwaysApply: true
---
# GitHub Action AI Self Builder - 核心规则（共享）

## ⚠️ 使用说明

**此规则文件适用于使用本项目的父项目。**

**在父项目中使用时**:
- 如果本项目作为 Git Submodule 或依赖项，路径可能需要调整
- 所有路径引用都是相对于本项目根目录的
- 在父项目中创建 Pipeline 时，需要根据实际项目结构调整导入路径

## 项目概述

本项目是一个通用的 GitHub Action 从零构建脚手架工具。核心目标是通过标准化的流水线脚本基类和脚手架工具，配合 AI 协助，为任意 GitHub 项目快速生成构建、测试、发布等功能的 GitHub Action 工作流。

## 核心架构

### 1. 流水线脚本基类设计

- 所有流水线脚本必须继承自 `BasePipeline` 基类
- 每个派生类对应生成一个独立的 GitHub Action 工作流
- 派生类必须实现 `execute()` 方法来完成具体功能
- 使用静态方法定义工作流配置（`getWorkflowInputs()`, `getWorkflowSetup()` 等）

### 2. 脚手架生成器

- 脚手架工具根据脚本派生类自动生成对应的 GitHub Action YAML 文件
- 生成的 YAML 文件符合 GitHub Actions 最佳实践
- 支持通过命令行参数指定输出路径和配置

### 3. 模块化架构

- **类型统一**: 所有工作流相关类型定义在本项目的 `src/types/workflow-types.ts`
- **配置构建器**: 使用 `WorkflowConfig` 类及其子构建器（`SetupBuilder`, `TriggerBuilder`）构建配置
- **Pipeline 注册表**: 使用 `PipelineRegistry` 管理 Pipeline 类的注册和查找

> **注意**: 在父项目中使用时，导入路径需要根据实际的项目结构调整（如 Git Submodule 路径）

## 如何使用

### Pipeline 存放位置

**重要**: 父项目的 Pipeline 可以放在任何位置，通过配置文件指定。

**默认位置**:
- 默认在项目根目录的 `src/pipelines/` 目录下查找 Pipeline 文件

**自定义位置**:
- 在父项目根目录创建 `config.yaml` 文件
- 通过 `pipelines.scripts_dir` 配置自定义 Pipeline 目录

**配置示例** (`config.yaml`):
```yaml
pipelines:
  scripts_dir: "src/pipelines"        # 默认值
  # 或自定义位置：
  # scripts_dir: "workflows/pipelines"
  # scripts_dir: "custom/pipeline-scripts"
```

**工作原理**:
- 脚手架工具会从运行目录向上查找项目根目录（包含 `package.json` 的目录）
- 读取项目根目录的 `config.yaml` 配置文件（如果存在）
- 使用配置的 `pipelines.scripts_dir` 或默认的 `src/pipelines/` 目录查找 Pipeline 文件

### 创建 Pipeline 类

**在父项目中使用时，需要根据实际路径调整导入**：

```typescript
// 在父项目中使用时，需要根据实际路径调整导入：
// 
// 方式 1: 如果本项目作为 Git Submodule（假设子模块名为 GithubActionAISelfBuilder）
// import { BasePipeline, PipelineResult } from '../../GithubActionAISelfBuilder/src/base-pipeline';
// import { createWorkflowConfig } from '../../GithubActionAISelfBuilder/src/workflow-config';
//
// 方式 2: 如果直接使用 npm 包
// import { BasePipeline, PipelineResult } from '@your-org/github-action-builder/base-pipeline';
// import { createWorkflowConfig } from '@your-org/github-action-builder/workflow-config';
//
// 方式 3: 如果使用相对路径（需要根据实际项目结构调整）
// import { BasePipeline, PipelineResult } from '<本项目相对路径>/src/base-pipeline';
// import { createWorkflowConfig } from '<本项目相对路径>/src/workflow-config';

export class YourPipeline extends BasePipeline {
  static getWorkflowInputs() {
    const config = createWorkflowConfig();
    config.addInput('input-name', '输入参数描述', false, 'default-value');
    return config.toDict().inputs || {};
  }

  static getWorkflowSetup() {
    const config = createWorkflowConfig();
    config.setupNode('18', 'npm');
    return config.toDict().setup || {};
  }

  static getWorkflowTriggers() {
    const config = createWorkflowConfig();
    config.onPush(['main', 'develop']);
    config.onPullRequest(['main']);
    return config.toDict().triggers || {};
  }

  static getWorkflowRunsOn(): string {
    return 'ubuntu-latest';
  }

  async execute(): Promise<PipelineResult> {
    try {
      this.log('info', '开始执行流水线...');
      
      const success = await this.runCommand('your-command');
      
      if (!success) {
        return {
          success: false,
          message: '执行失败',
          exitCode: 1,
        };
      }

      return {
        success: true,
        message: '执行成功',
        exitCode: 0,
      };
    } catch (error: any) {
      return {
        success: false,
        message: `执行过程中发生错误: ${error.message}`,
        exitCode: 1,
      };
    }
  }
}
```

### 生成 GitHub Action 工作流

**在父项目中使用时，需要在父项目根目录运行脚手架工具**：

```bash
# 方式 1: 在父项目根目录运行（推荐）
# 脚手架工具会自动检测父项目根目录，查找 src/pipelines/ 目录
cd <父项目根目录>
node <本项目路径>/dist/src/scaffold.js --pipeline YourPipeline --output .github/workflows/your-pipeline.yml

# 方式 2: 如果在本项目目录中运行，需要指定父项目路径
cd <本项目路径>
npm run scaffold -- --pipeline YourPipeline --output <父项目路径>/.github/workflows/your-pipeline.yml

# 方式 3: 在父项目中安装依赖后使用（如果配置了 npm scripts）
cd <父项目根目录>
npm run scaffold -- --pipeline YourPipeline --output .github/workflows/your-pipeline.yml
```

**重要说明**:
- 脚手架工具会从运行目录向上查找包含 `package.json` 的目录作为项目根目录
- Pipeline 文件位置可以通过 `config.yaml` 中的 `pipelines.scripts_dir` 配置
- 默认在项目根目录的 `src/pipelines/` 目录下查找（如果未配置）

### 使用流程

1. **创建 Pipeline 类**: 继承 `BasePipeline`，实现 `execute()` 方法
2. **定义配置**: 使用静态方法定义工作流输入、设置、触发条件
3. **生成工作流**: 使用脚手架工具生成 YAML 文件
4. **使用工作流**: 在 GitHub Actions 中使用生成的工作流

## AI 协助开发

### 创建新的流水线脚本

1. **选择 Pipeline 存放位置**
   - 可以在父项目的任何位置创建 Pipeline 文件
   - 推荐放在 `src/pipelines/` 目录（默认位置）
   - 或自定义位置，并在 `config.yaml` 中配置 `pipelines.scripts_dir`

2. **创建 Pipeline 文件**
   - 在选定的目录创建新的 TypeScript 文件
   - 脚手架工具会根据配置自动扫描该目录

3. **根据实际项目结构导入 `BasePipeline` 基类和类型**
   - 导入路径需要指向本项目的 `src/base-pipeline.ts` 和 `src/workflow-config.ts`
   - 示例（Git Submodule）: `import { BasePipeline } from '../../GithubActionAISelfBuilder/src/base-pipeline';`
   - 示例（npm 包）: `import { BasePipeline } from '@your-org/github-action-builder/base-pipeline';`

4. **创建派生类并实现 `execute()` 方法**

5. **使用静态方法定义工作流配置**

6. **使用脚手架工具生成工作流**
   - 在父项目根目录运行脚手架工具
   - 脚手架工具会根据配置查找 Pipeline 文件

### 生成 GitHub Action 工作流

1. 分析流水线脚本派生类的功能和依赖
2. 使用脚手架工具生成符合 GitHub Actions 规范的 YAML 文件
3. 验证生成的 YAML 语法和逻辑

### 组合多个流水线

1. 分析各个流水线之间的依赖关系
2. 创建组合工作流，使用 `needs` 关键字处理依赖
3. 优化并行执行和缓存策略

## 环境要求

- **Node.js**: 18.0 或更高版本
- **TypeScript**: 5.3+
- **npm**: 支持 workspaces


## 相关文档

- **项目文档**: `README.md`（位于本项目根目录）
- **脚本使用**: `.cursor/rules/scripts-usage.mdc`（本规则文件）
- **父项目 Pipeline 指南**: `docs/parent-project-pipelines.md`（详细说明）

> **注意**: 
> - 项目特定的开发规则位于 `ProjectOnly/` 目录，在注入到父项目时会被删除，因此共享规则不引用这些内容
> - 在父项目中使用时，所有路径引用需要根据实际的项目结构调整
