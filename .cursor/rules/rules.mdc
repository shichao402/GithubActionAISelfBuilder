---
description: 为 GitHub Action AI Self Builder 项目提供开发规范和最佳实践指导
globs: ["**/*.py", "**/*.md", "**/*.yml", "**/*.yaml", "**/*.json"]
tags: ["GitHub Action", "Python", "脚手架", "CI/CD"]
priority: 1
version: 1.0.0
---

# GitHub Action AI Self Builder - 核心 MCP 规则

## 项目概述

本项目是一个通用的 GitHub Action 从零构建脚手架工具。核心目标是通过标准化的流水线脚本基类和脚手架工具，配合 AI 协助，为任意 GitHub 项目快速生成构建、测试、发布等功能的 GitHub Action 工作流。

## 技术栈和约束

- **语言**: Python 3.7+
- **环境管理**: 必须使用 venv 虚拟环境
- **平台支持**: Windows, macOS, Linux（必须提供跨平台支持）
- **依赖管理**: 使用 requirements.txt
- **代码风格**: 遵循 PEP 8 Python 编码规范

## 核心架构原则

### 1. 流水线脚本基类设计

- 所有流水线脚本必须继承自 `BasePipeline` 基类
- 每个派生类对应生成一个独立的 GitHub Action 工作流
- 基类应提供标准化的接口和通用功能
- 派生类必须实现 `execute()` 方法来完成具体功能

### 2. 脚手架生成器

- 脚手架工具必须能够根据脚本派生类自动生成对应的 GitHub Action YAML 文件
- 生成的 YAML 文件应符合 GitHub Actions 最佳实践
- 支持通过命令行参数指定输出路径和配置

### 3. 配置文件系统

- 配置文件支持 JSON 或 YAML 格式
- 配置文件应支持扩展和定制流水线行为
- 配置文件应放在 `config/` 目录下

### 4. 跨平台支持

- 所有脚本和工具必须支持 Windows、macOS、Linux 三个平台
- 提供对应的安装脚本：install.sh (Linux/macOS), install.bat (Windows), install.ps1 (Windows PowerShell)
- 环境激活命令需要考虑不同平台的差异

## AI 协助开发规则

### 当用户请求创建新的流水线脚本时：

1. **检查基类**: 首先确认 `BasePipeline` 基类存在且接口清晰
2. **创建派生类**: 在 `src/pipelines/` 目录下创建新的 Python 文件
3. **实现接口**: 确保实现 `execute()` 方法和其他必要的抽象方法
4. **添加配置**: 如果需要，在 `config/` 目录下创建对应的配置文件
5. **文档说明**: 为新流水线添加清晰的文档字符串和注释

### 当用户请求生成 GitHub Action 工作流时：

1. **分析脚本**: 理解流水线脚本派生类的功能和依赖
2. **生成 YAML**: 使用脚手架工具生成符合 GitHub Actions 规范的 YAML 文件
3. **优化配置**: 确保生成的工作流包含必要的触发条件、环境变量、步骤等
4. **验证语法**: 确保生成的 YAML 语法正确且可执行

### 当用户请求组合多个流水线时：

1. **分析依赖**: 理解各个流水线之间的依赖关系和执行顺序
2. **创建工作流**: 创建新的组合工作流，合理组织多个流水线
3. **处理依赖**: 使用 GitHub Actions 的 `needs` 关键字处理流水线依赖
4. **优化性能**: 考虑并行执行和缓存策略

## 代码组织规范

### 目录结构

```
GithubActionAISelfBuilder/
├── README.md                 # 项目文档（必须保持更新）
├── requirements.txt          # Python 依赖（必须保持更新）
├── .cursor/
│   └── rules/
│       └── rules.mdc         # AI 规则文件（本文件）
├── .github/
│   └── workflows/           # 生成的 GitHub Action 工作流
├── scripts/                 # 跨平台安装脚本
│   ├── install.sh           # Linux/macOS
│   ├── install.bat          # Windows CMD
│   └── install.ps1          # Windows PowerShell
├── src/
│   ├── base_pipeline.py     # 流水线基类（核心）
│   ├── scaffold.py          # 脚手架生成器（核心）
│   └── pipelines/           # 流水线脚本派生类
│       └── __init__.py
└── config/                  # 配置文件目录
```

### 文件命名规范

- Python 文件使用小写字母和下划线：`base_pipeline.py`
- 类名使用大驼峰命名：`BasePipeline`, `BuildPipeline`
- 配置文件使用小写字母和连字符：`build-config.json`

### 代码风格

- 使用 4 个空格缩进（不使用 Tab）
- 行长度限制在 88 字符（Black 标准）
- 函数和类必须有文档字符串
- 使用类型提示（Type Hints）

## 开发工作流

### 标准开发流程

1. **环境准备**: 确保 venv 环境已激活
2. **编写脚本**: 创建或修改流水线脚本派生类
3. **测试验证**: 在本地测试脚本功能
4. **生成工作流**: 使用脚手架工具生成 GitHub Action YAML
5. **验证工作流**: 检查生成的 YAML 语法和逻辑
6. **更新文档**: 更新 README.md 和相关文档

### 创建新流水线的步骤

1. 在 `src/pipelines/` 创建新的 Python 文件
2. 导入 `BasePipeline` 基类
3. 创建派生类并实现必要方法
4. 在 `src/pipelines/__init__.py` 中导出新类
5. 创建对应的配置文件（如需要）
6. 使用脚手架工具生成工作流
7. 更新文档

## 最佳实践

### 流水线脚本设计

- **单一职责**: 每个流水线脚本只负责一个特定功能
- **可配置性**: 通过配置文件或参数支持定制
- **错误处理**: 实现完善的错误处理和日志记录
- **可测试性**: 代码结构应便于单元测试

### GitHub Action 工作流生成

- **触发条件**: 合理设置工作流触发条件（push, pull_request 等）
- **环境变量**: 正确配置必要的环境变量和 secrets
- **步骤组织**: 逻辑清晰地组织工作流步骤
- **缓存策略**: 合理使用缓存提高执行效率
- **错误处理**: 添加适当的错误处理和通知机制

### 跨平台兼容性

- **路径处理**: 使用 `pathlib` 或 `os.path` 处理路径，避免硬编码
- **命令执行**: 使用跨平台的命令和工具
- **脚本测试**: 在多个平台上测试脚本功能

## 注意事项

1. **虚拟环境**: 始终在 venv 环境中开发和运行代码
2. **依赖管理**: 添加新依赖时及时更新 requirements.txt
3. **版本兼容**: 确保代码兼容 Python 3.7+
4. **文档同步**: 代码变更时同步更新文档
5. **测试覆盖**: 尽可能为新功能添加测试

## AI 助手行为指南

当协助用户开发时：

1. **理解需求**: 充分理解用户想要实现的功能
2. **遵循架构**: 严格遵循项目的架构设计原则
3. **提供示例**: 提供清晰、可运行的代码示例
4. **解释设计**: 解释设计决策和实现细节
5. **检查完整性**: 确保生成的代码完整且可执行
6. **跨平台考虑**: 始终考虑跨平台兼容性
7. **文档更新**: 提醒用户更新相关文档

## 常见任务模板

### 创建新的流水线脚本模板

```python
from src.base_pipeline import BasePipeline

class YourPipeline(BasePipeline):
    """
    流水线描述
    """
    
    def __init__(self, config=None):
        super().__init__(config)
        # 初始化配置
    
    def execute(self):
        """
        执行流水线逻辑
        """
        # 实现具体功能
        pass
    
    def validate(self):
        """
        验证配置和前置条件
        """
        # 实现验证逻辑
        return True
```

### 生成 GitHub Action 工作流命令

```bash
python src/scaffold.py --pipeline YourPipeline --output .github/workflows/your-pipeline.yml
```

## 使用流程详解

### 步骤 0: 了解基础架构

本项目提供了标准化的流水线脚本基类。设计上，每一个脚本派生类都可以对应生成一个 GitHub Action 工作流。

**关键点**:
- 基类 `BasePipeline` 定义了标准接口
- 每个派生类代表一个独立的流水线功能
- 派生类与 GitHub Action 工作流一一对应

### 步骤 1: 编写流水线脚本派生类

在 AI 的协助下，编写具体的流水线脚本派生类，完成特定功能（如构建、测试、部署等），并扩展相应的配置文件。

**工作内容**:
1. 分析需求，确定流水线功能
2. 创建派生类文件
3. 实现 `execute()` 方法
4. 添加配置文件和参数
5. 编写文档和注释

### 步骤 2: 生成 GitHub Action 工作流

使用本项目提供的脚手架工具，根据脚本派生类自动生成对应的 GitHub Action 工作流 YAML 文件。

**命令格式**:
```bash
python src/scaffold.py --pipeline <PipelineClass> --output .github/workflows/<workflow-name>.yml
```

**生成内容**:
- 工作流触发条件
- 运行环境配置
- 执行步骤
- 环境变量和 secrets
- 错误处理机制

### 步骤 3: 组织多个流水线

在 AI 的协助下，将多个脚本流水线组合成更复杂的 GitHub Action 工作流，实现完整的 CI/CD 流程。

**组合策略**:
- 使用 `needs` 关键字定义依赖关系
- 合理使用并行和串行执行
- 优化缓存和性能
- 添加通知和报告机制

## 环境配置说明

### 虚拟环境管理

**创建虚拟环境**:
```bash
# Windows
python -m venv venv

# macOS/Linux
python3 -m venv venv
```

**激活虚拟环境**:
```bash
# Windows PowerShell
.\venv\Scripts\Activate.ps1

# Windows CMD
.\venv\Scripts\activate.bat

# macOS/Linux
source venv/bin/activate
```

**安装依赖**:
```bash
pip install -r requirements.txt
```

### 跨平台脚本说明

- `install.sh`: Linux/macOS 安装脚本，使用 bash
- `install.bat`: Windows CMD 批处理脚本
- `install.ps1`: Windows PowerShell 脚本

所有安装脚本应执行相同的操作：
1. 检查 Python 版本
2. 创建虚拟环境
3. 安装依赖
4. 验证安装

## 脚手架工具使用规范

### 命令行参数

脚手架工具 `scaffold.py` 应支持以下参数：

- `--pipeline`: 指定流水线类名（必需）
- `--output`: 指定输出文件路径（必需）
- `--config`: 指定配置文件路径（可选）
- `--trigger`: 指定触发条件（可选，默认：push, pull_request）
- `--matrix`: 指定矩阵策略（可选）

### 生成的 YAML 结构

生成的 GitHub Action 工作流应包含：

1. **name**: 工作流名称
2. **on**: 触发条件
3. **jobs**: 作业定义
   - **runs-on**: 运行环境
   - **steps**: 执行步骤
   - **env**: 环境变量
   - **needs**: 依赖关系（如适用）

## 配置文件规范

### 配置文件位置

- 所有配置文件应放在 `config/` 目录下
- 配置文件命名：`<pipeline-name>-config.json` 或 `<pipeline-name>-config.yaml`

### 配置文件结构

```json
{
  "pipeline": {
    "name": "PipelineName",
    "description": "Pipeline description",
    "steps": [
      {
        "name": "Step name",
        "run": "command to run",
        "env": {}
      }
    ],
    "triggers": {
      "push": {
        "branches": ["main", "develop"]
      },
      "pull_request": {
        "branches": ["main"]
      }
    }
  }
}
```

## 错误处理规范

### 流水线脚本错误处理

- 所有可能失败的操作都应使用 try-except
- 记录详细的错误日志
- 返回明确的错误码和消息
- 支持优雅降级

### GitHub Action 工作流错误处理

- 使用 `continue-on-error` 处理非关键步骤
- 使用 `if` 条件控制步骤执行
- 添加错误通知机制
- 提供清晰的错误信息

## 日志记录规范

### 日志级别

- **DEBUG**: 详细的调试信息
- **INFO**: 一般信息，记录正常流程
- **WARNING**: 警告信息，不影响执行但需要注意
- **ERROR**: 错误信息，影响功能但可恢复
- **CRITICAL**: 严重错误，导致流程中断

### 日志格式

- 使用结构化日志格式
- 包含时间戳、级别、模块、消息
- 支持输出到文件和控制台
- 在 GitHub Action 中使用 `::notice::` 和 `::error::` 格式

### 日志示例

```python
import logging

logger = logging.getLogger(__name__)
logger.info("Pipeline execution started")
logger.error("Failed to execute step", exc_info=True)
```

## 测试规范

### 单元测试

- 为每个流水线脚本编写单元测试
- 测试覆盖率应达到 80% 以上
- 使用 pytest 作为测试框架
- 测试文件命名：`test_<module_name>.py`
- 测试函数命名：`test_<function_name>`

### 集成测试

- 测试脚手架工具生成的工作流
- 验证生成的 YAML 语法正确性
- 测试跨平台兼容性
- 使用 GitHub Actions 进行 CI 测试

### 测试目录结构

```
tests/
├── unit/
│   ├── test_base_pipeline.py
│   └── test_scaffold.py
├── integration/
│   └── test_workflow_generation.py
└── fixtures/
    └── sample_configs/
```

## 版本管理规范

### 语义化版本

- 遵循语义化版本规范 (SemVer): `MAJOR.MINOR.PATCH`
- **MAJOR**: 不兼容的 API 变更
- **MINOR**: 向后兼容的功能新增
- **PATCH**: 向后兼容的问题修复

### 版本更新

- 在 `requirements.txt` 中固定依赖版本
- 重大更新时更新规则文件版本号
- 在 README.md 中记录版本变更

## 更新日志

- 规则文件应随项目演进持续更新
- 重大架构变更时需更新本规则文件
- 版本号应随重大更新递增
