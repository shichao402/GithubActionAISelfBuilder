---
alwaysApply: true
---

# Scripts 使用规则 - 共享给目标项目

## 概述

本目录包含可共享给其他项目使用的脚本工具。当本项目作为子项目（Git Submodule）被其他项目使用时，这些脚本可以帮助父项目进行 GitHub Actions 的调试和管理。

## ⚠️ 在父项目中使用

**重要**: 当本项目被注入到父项目时：
- `ProjectOnly/` 目录下的所有文件**会被删除**
- 共享规则文件（本文件）会保留在父项目中
- 父项目需要根据实际路径调整脚本和命令的引用

**路径调整原则**:
1. **导入路径**: 需要指向本项目的实际位置
   - 如果作为 Git Submodule，使用相对路径：`<子模块路径>/src/...`
   - 如果使用 npm 包，使用包名：`@your-org/github-action-builder/...`
2. **命令路径**: 需要在本项目目录下执行，或使用绝对路径
3. **脚本路径**: 复制脚本后需要调整脚本内部的导入路径

## 目录结构说明

### ProjectOnly 目录

**重要**: `ProjectOnly/` 目录下的所有文件（脚本或规则）都是**本项目特有的**，在注入到父项目时**会被删除**。

**关键特性**:
- ✅ 本项目开发时：ProjectOnly 文件可用
- ❌ 注入到父项目时：ProjectOnly 目录下的所有文件**会被删除**
- 🚫 **共享规则和脚本不得引用 ProjectOnly 的内容**，避免父项目找不到引用

**包含内容**:
- **规则文件**: `.cursor/rules/ProjectOnly/` - 本项目特有的规则（会被删除）
- **脚本文件**: `scripts/ProjectOnly/` - 本项目特有的脚本（会被删除）

### 共享文件

不在 `ProjectOnly/` 目录下的文件可以共享给父项目使用。

## 共享脚本分类

### 1. Pipeline 验证和调试脚本（共享）

**位置**: `scripts/test-pipelines.ts`

**用途**: 自动化 Pipeline 验证和调试流程，包括生成 workflow、验证、触发测试和监控执行

**使用方式**:
```bash
# 在父项目中使用
npm run test:pipelines -- [options]
# 或直接使用
ts-node scripts/test-pipelines.ts [options]
```

**功能**:
- ✅ 删除旧的 workflow 文件（可选）
- ✅ 使用脚手架工具重新生成 workflow
- ✅ 验证生成的 workflow 文件（YAML 语法、结构检查）
- ✅ 触发 workflow 进行在线测试（可选）
- ✅ 监控 workflow 执行状态（可选）
- ✅ 分析失败原因并提供结果总结

**选项**:
- `--pipeline <name>`: 指定要测试的 Pipeline 类名（可多次指定）
- `--all`: 测试所有 Pipeline
- `--trigger`: 触发 workflow 进行在线测试
- `--watch`: 监控 workflow 执行状态
- `--clean`: 删除旧的 workflow 文件
- `--verify`: 仅验证生成的 workflow 文件，不触发测试

**使用示例**:
```bash
# 测试单个 Pipeline 并触发在线测试
npm run test:pipelines -- --pipeline FlutterBuildPipeline --trigger --watch

# 测试所有 Pipeline 并触发在线测试
npm run test:pipelines -- --all --trigger --watch

# 仅验证生成的 workflow 文件
npm run test:pipelines -- --all --verify

# 清理并重新生成所有 workflow
npm run test:pipelines -- --all --clean --verify
```

**使用场景**:
- 创建新的 Pipeline 后验证 workflow 生成是否正确
- 修改 Pipeline 后需要重新生成和验证 workflow
- 调试 workflow 执行问题
- 批量测试多个 Pipeline

**在父项目中使用**:
```bash
# 方式 1: 复制脚本到父项目（推荐）
cp <本项目路径>/scripts/test-pipelines.ts scripts/
# 调整脚本中的导入路径（如 ScaffoldGenerator 的导入）
npm run test:pipelines -- --pipeline YourPipeline --trigger

# 方式 2: 作为 Git Submodule 使用
cd <本项目路径>
npm run test:pipelines -- --pipeline YourPipeline --trigger
```

### 2. AI 调试工作流脚本（共享）

**位置**: `scripts/ai-debug-workflow.ts`

**用途**: AI 自我调试 GitHub Actions 工作流，自动触发、监控、收集日志并分析错误

**使用方式**:
```bash
# 在父项目中使用（复制脚本后）
ts-node scripts/ai-debug-workflow.ts <workflow-file> [ref]
# 或创建 npm 脚本
npm run ai-debug -- .github/workflows/build.yml main
```

**功能**:
- ✅ 自动触发 GitHub Action 工作流
- ✅ 实时监控工作流执行状态
- ✅ 失败时自动收集详细错误日志
- ✅ 分析日志并提供修正建议

**使用场景**:
- 父项目的 GitHub Action 工作流失败时
- 需要调试和修正工作流配置时
- 需要验证工作流修复是否成功时

## 在父项目中使用

### 方式 1: 直接复制脚本（推荐）

由于脚本位于 `ProjectOnly/` 目录（注入时会被删除），建议直接复制到父项目：

```bash
# 在注入前复制 AI 调试脚本到父项目
# 注意：需要根据实际的项目路径调整
cp <本项目路径>/scripts/ProjectOnly/ai-debug-workflow.ts scripts/

# 在父项目中使用
ts-node scripts/ai-debug-workflow.ts .github/workflows/build.yml main
```

**路径说明**:
- `<本项目路径>` 需要根据实际的项目结构替换（如 Git Submodule 路径）
- 复制后需要调整脚本中的导入路径（如 `WorkflowManager` 的导入）
- 导入路径需要指向本项目的 `src/workflow-manager.ts`

### 方式 2: 创建 npm 脚本包装

在父项目的 `package.json` 中添加：

```json
{
  "scripts": {
    "ai-debug": "ts-node scripts/ai-debug-workflow.ts"
  }
}
```

然后使用：
```bash
npm run ai-debug -- .github/workflows/build.yml main
```

### 方式 3: 作为 Git Submodule（需要调整路径）

如果使用 Git Submodule，需要调整脚本中的导入路径：

```bash
# 在父项目中添加子模块（可以使用自定义名称）
git submodule add <仓库URL> <子模块名称>

# 在注入前复制脚本到父项目（推荐）
cp <子模块路径>/scripts/ProjectOnly/ai-debug-workflow.ts scripts/

# 复制后需要调整脚本中的导入路径
# 例如：将 '../../src/workflow-manager' 改为 '<子模块相对路径>/src/workflow-manager'
# 或者使用绝对路径：path.resolve(__dirname, '<子模块路径>', 'src', 'workflow-manager')
```

## AI 助手行为规则

### Pipeline 验证和调试

当父项目需要验证或调试 Pipeline 时：

1. **必须使用 Pipeline 验证脚本**
   - 使用 `npm run test:pipelines` 或 `scripts/test-pipelines.ts`
   - 脚本会自动完成：清理、生成、验证、触发、监控的完整流程
   - 禁止手动执行这些步骤

2. **标准验证流程**:
   ```bash
   # 1. 清理并重新生成所有 workflow
   npm run test:pipelines -- --all --clean
   
   # 2. 验证生成的 workflow 文件
   npm run test:pipelines -- --all --verify
   
   # 3. 触发在线测试并监控
   npm run test:pipelines -- --all --trigger --watch
   ```

3. **禁止的操作**:
   - ❌ 手动删除和重新生成 workflow 文件
   - ❌ 不验证就推送代码
   - ❌ 不触发在线测试就认为 workflow 正确

### GitHub Action 工作流调试

当父项目需要调试 GitHub Action 工作流时：

1. **必须使用本项目提供的 AI 调试脚本**
   - 使用 `npm run ai-debug` 或 `scripts/ai-debug-workflow.ts`
   - 禁止手动分析或猜测错误原因

2. **遵循调试流程**:
   - 触发工作流
   - 监控执行状态
   - 收集失败日志
   - 分析错误并修正
   - 重新验证

3. **禁止的操作**:
   - ❌ 不收集日志就猜测错误原因
   - ❌ 手动查看 GitHub 网页界面分析错误（除非无法使用脚本）
   - ❌ 不验证修正就推送代码

## 脚本依赖

使用这些脚本需要：

1. **Node.js 18+**: 确保已安装 Node.js
2. **TypeScript**: 需要 `ts-node` 或编译后的 JavaScript
3. **GitHub CLI**: 需要安装并登录 GitHub CLI (`gh auth login`)
4. **项目依赖**: 如果使用 TypeScript 脚本，需要安装项目依赖

## 示例：完整的调试流程

### Pipeline 验证流程

```bash
# 1. 清理并重新生成所有 workflow
npm run test:pipelines -- --all --clean

# 2. 验证生成的 workflow 文件
npm run test:pipelines -- --all --verify

# 3. 触发在线测试并监控
npm run test:pipelines -- --all --trigger --watch

# 4. 如果失败，查看详细日志
gh run view <run-id> --log-failed
```

### 工作流调试流程

```bash
# 1. 触发并监控工作流
npm run ai-debug -- .github/workflows/build.yml main

# 2. 如果失败，脚本会自动：
#    - 收集错误日志
#    - 分析错误原因
#    - 提供修正建议

# 3. 根据建议修正工作流或代码

# 4. 重新触发验证
npm run ai-debug -- .github/workflows/build.yml main
```

## 注意事项

1. **路径问题**: 
   - 如果作为子模块使用，注意脚本中的相对路径可能需要调整
   - 所有路径引用需要根据父项目的实际结构调整
   - 导入路径（如 `import` 语句）需要指向正确的模块位置

2. **ProjectOnly 文件**: 
   - `ProjectOnly/` 目录下的文件在注入到父项目时会被删除
   - 需要使用的脚本应在注入前复制到父项目
   - 复制后需要调整脚本中的导入路径

3. **权限问题**: 确保 GitHub CLI 有足够的权限访问仓库

4. **环境变量**: 某些脚本可能需要特定的环境变量

5. **跨平台**: TypeScript 脚本跨平台，Shell/PowerShell 脚本需要对应平台

## 更新日志

- 2025-12-01: 添加 Pipeline 验证和调试脚本规则
- 2025-11-30: 初始版本，包含 Git 推送和 AI 调试脚本规则
