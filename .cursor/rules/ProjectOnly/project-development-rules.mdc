---
alwaysApply: true
---

# 项目开发规则（非共享）

## ⚠️ 重要说明

**此规则文件位于 `ProjectOnly/` 目录，仅适用于本项目开发。**

**关键特性**:
- ✅ 本项目开发时：此规则会被应用
- ❌ 注入到父项目时：`ProjectOnly/` 目录下的所有文件（包括此规则）**会被删除**
- 🚫 **禁止在共享规则中引用 ProjectOnly 的内容**，避免父项目找不到引用

**设计目的**:
- 隔离项目特定的开发规范，不影响父项目
- 确保共享规则文件独立完整，不依赖 ProjectOnly 内容
- 避免父项目因缺少 ProjectOnly 文件而出现错误

## 项目概述

本项目是一个通用的 GitHub Action 从零构建脚手架工具。核心目标是通过标准化的流水线脚本基类和脚手架工具，配合 AI 协助，为任意 GitHub 项目快速生成构建、测试、发布等功能的 GitHub Action 工作流。

## 技术栈

- **语言**: TypeScript 5.3+
- **运行时**: Node.js 18.0+
- **包管理**: npm (支持 workspaces)
- **平台支持**: Windows, macOS, Linux（必须提供跨平台支持）
- **测试框架**: Jest
- **构建工具**: TypeScript Compiler (tsc)

## 目录结构

```
GithubActionAISelfBuilder/
├── README.md                 # 项目文档
├── package.json              # Node.js 依赖和脚本
├── tsconfig.json             # TypeScript 配置
├── jest.config.js            # Jest 测试配置
├── .cursor/
│   └── rules/
│       ├── rules.mdc         # AI 规则文件（共享）
│       ├── scripts-usage.mdc # 脚本使用规则（共享）
│       └── ProjectOnly/      # 本项目特有的规则（不共享）
├── .github/
│   └── workflows/           # 生成的 GitHub Action 工作流
├── scripts/                 # 工具脚本
│   ├── install-nodejs.ps1   # Node.js 安装脚本（可共享）
│   └── ProjectOnly/         # 本项目特有的脚本（不共享）
├── src/
│   ├── base-pipeline.ts     # 流水线基类（核心）
│   ├── scaffold.ts          # 脚手架生成器（核心）
│   ├── workflow-config.ts   # 工作流配置构建器
│   ├── workflow-manager.ts  # 工作流管理器
│   ├── pipeline-registry.ts # Pipeline 注册表
│   ├── types/               # 类型定义
│   ├── workflow-config/     # 配置构建器子模块
│   ├── pipelines/           # 流水线脚本派生类
│   └── __tests__/           # 单元测试
├── config/                  # 配置文件目录
└── dist/                    # 编译输出目录
```

## 文件命名规范

- TypeScript 文件使用小写字母和连字符：`base-pipeline.ts`
- 类名使用大驼峰命名：`BasePipeline`, `BuildPipeline`
- 接口和类型使用大驼峰命名：`PipelineResult`, `WorkflowConfig`
- 配置文件使用小写字母和连字符：`config.yaml`
- 测试文件使用 `*.test.ts` 后缀

## 代码风格

- 使用 2 个空格缩进（不使用 Tab）
- 行长度限制在 100 字符（Prettier 标准）
- 函数和类必须有 JSDoc 注释
- 使用 TypeScript 类型注解（Type Annotations）
- 遵循 ESLint 规则
- 使用 Prettier 格式化代码

## 开发工作流

### 标准开发流程

1. **环境准备**: 确保 Node.js 18+ 已安装，运行 `npm install` 安装依赖
2. **编写脚本**: 创建或修改流水线脚本派生类（TypeScript）
3. **类型检查**: 运行 `npm run build` 检查类型错误
4. **测试验证**: 运行 `npm test` 执行单元测试
5. **生成工作流**: 使用脚手架工具生成 GitHub Action YAML
6. **验证工作流**: 检查生成的 YAML 语法和逻辑
7. **更新文档**: 更新 README.md 和相关文档
8. **推送代码**: **必须使用一键推送脚本** (`npm run push` 或对应平台的脚本)

### Git 推送规范

**重要规则**: AI 助手在推送代码到远程仓库时，**必须且只能**使用项目提供的一键推送脚本，禁止直接使用 `git push` 命令。

**快速参考**:
- 推荐方式: `npm run push [提交信息]`
- 其他方式: `ts-node scripts/ProjectOnly/push-git.ts [提交信息]` 或对应平台的脚本

> **详细规范**: 请参考 `.cursor/rules/ProjectOnly/git-push-rule.mdc`

### 创建新流水线的步骤

1. 在 `src/pipelines/` 创建新的 TypeScript 文件（如 `my-pipeline.ts`）
2. 导入 `BasePipeline` 基类和类型
3. 创建派生类并实现 `execute()` 方法
4. 实现静态方法定义工作流配置（`getWorkflowInputs()`, `getWorkflowSetup()` 等）
5. 可选：注册到 `PipelineRegistry` 以便查找
6. 创建对应的配置文件（如需要）
7. 使用脚手架工具生成工作流：`npm run scaffold -- --pipeline MyPipeline --output .github/workflows/my-pipeline.yml`
8. 编写单元测试
9. 更新文档

## 最佳实践

### 流水线脚本设计

- **单一职责**: 每个流水线脚本只负责一个特定功能
- **可配置性**: 通过配置文件或参数支持定制
- **错误处理**: 实现完善的错误处理和日志记录
- **可测试性**: 代码结构应便于单元测试

### GitHub Action 工作流生成

- **触发条件**: 合理设置工作流触发条件（push, pull_request 等）
- **环境变量**: 正确配置必要的环境变量和 secrets
- **步骤组织**: 逻辑清晰地组织工作流步骤
- **缓存策略**: 合理使用缓存提高执行效率
- **错误处理**: 添加适当的错误处理和通知机制

### 跨平台兼容性

- **路径处理**: 使用 Node.js `path` 模块处理路径，避免硬编码
- **命令执行**: 使用跨平台的命令和工具
- **脚本测试**: 在多个平台上测试脚本功能
- **文件系统**: 使用 Node.js `fs` 模块，注意异步操作

## 配置文件规范

### 配置文件位置

- 所有配置文件应放在 `config/` 目录下
- 配置文件命名：`<pipeline-name>-config.json` 或 `<pipeline-name>-config.yaml`

### 配置文件结构

```json
{
  "pipeline": {
    "name": "PipelineName",
    "description": "Pipeline description",
    "steps": [
      {
        "name": "Step name",
        "run": "command to run",
        "env": {}
      }
    ],
    "triggers": {
      "push": {
        "branches": ["main", "develop"]
      },
      "pull_request": {
        "branches": ["main"]
      }
    }
  }
}
```

## 错误处理规范

### 流水线脚本错误处理

- 所有可能失败的操作都应使用 try-except
- 记录详细的错误日志
- 返回明确的错误码和消息
- 支持优雅降级

### GitHub Action 工作流错误处理

- 使用 `continue-on-error` 处理非关键步骤
- 使用 `if` 条件控制步骤执行
- 添加错误通知机制
- 提供清晰的错误信息

## 日志记录规范

### 日志级别

- **DEBUG**: 详细的调试信息
- **INFO**: 一般信息，记录正常流程
- **WARNING**: 警告信息，不影响执行但需要注意
- **ERROR**: 错误信息，影响功能但可恢复
- **CRITICAL**: 严重错误，导致流程中断

### 日志格式

- 使用结构化日志格式
- 包含时间戳、级别、模块、消息
- 支持输出到文件和控制台
- 在 GitHub Action 中使用 `::notice::` 和 `::error::` 格式

## 测试规范

### 单元测试

- 为每个流水线脚本编写单元测试
- 测试覆盖率应达到 80% 以上
- 使用 Jest 作为测试框架
- 测试文件命名：`<module-name>.test.ts`
- 测试文件放在 `src/__tests__/` 目录下

> **详细规则**: 请参考 `.cursor/rules/ProjectOnly/testing-core-rules.mdc`

## 注意事项

1. **Node.js 版本**: 确保使用 Node.js 18.0+ 版本
2. **依赖管理**: 添加新依赖时及时更新 package.json，运行 `npm install`
3. **类型安全**: 充分利用 TypeScript 类型系统，避免使用 `any`
4. **版本兼容**: 确保代码兼容 Node.js 18+
5. **文档同步**: 代码变更时同步更新文档
6. **测试覆盖**: 尽可能为新功能添加测试，使用 Jest 框架
7. **构建检查**: 推送前运行 `npm run build` 确保编译通过
8. **模块化**: 遵循项目的模块化架构，使用统一的类型定义

## AI 助手行为指南

当协助用户开发时：

1. **理解需求**: 充分理解用户想要实现的功能
2. **遵循架构**: 严格遵循项目的架构设计原则
3. **提供示例**: 提供清晰、可运行的代码示例
4. **解释设计**: 解释设计决策和实现细节
5. **检查完整性**: 确保生成的代码完整且可执行
6. **跨平台考虑**: 始终考虑跨平台兼容性
7. **文档更新**: 提醒用户更新相关文档
8. **Git 推送规范**: **必须使用项目提供的一键推送脚本**
9. **GitHub Action 调试规范**: **必须使用项目提供的 AI 自我调试脚本**
   - ✅ **必须使用** `npm run ai-debug -- <workflow-file> [ref] [-f key=value ...]`
   - ❌ **严格禁止**手动运行 `gh workflow run` 命令
   - ❌ **严格禁止**使用复杂的命令行拼接（如 `gh workflow run ... && sleep ... && node -e "..."`）
   - ❌ **严格禁止**手动使用 `WorkflowManager` 类而不通过脚本
   - 详细规则请参考: `.cursor/rules/scripts-usage.mdc`
