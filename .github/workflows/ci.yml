# CI 组合工作流
# 这个工作流串联了构建和测试两个流水线

name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - "release/**"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build-type:
        description: '构建类型'
        required: false
        default: 'release'
      run-tests:
        description: '运行测试'
        required: false
        default: 'true'
      coverage-threshold:
        description: '覆盖率阈值'
        required: false
        default: '80'

jobs:
  # 第一个作业：构建
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Python version
        run: python --version
      
      - name: Check Git version
        run: git --version
      
      - name: Run Build Pipeline
        id: build
        env:
          PYTHONUNBUFFERED: '1'
          BUILD_TYPE: ${{ inputs.build-type || 'release' }}
          CI: 'true'
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          python -m src.pipelines.build_pipeline \
            --input project-name=${{ github.repository }} \
            --input build-type="${{ inputs.build-type || 'release' }}" \
            --input build-version=${{ github.ref_name }} \
            --input run-tests="false" \
            --input run-lint="true" \
            --input upload-artifacts="false"
      
      - name: Upload build artifacts
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: artifacts/
          retention-days: 7
  
  # 第二个作业：测试（依赖于构建）
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build  # 依赖构建作业
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: artifacts/
      
      - name: Check test dependencies
        run: |
          python -c "import pytest; print('pytest version:', pytest.__version__)" || echo "pytest not installed"
      
      - name: Run Test Pipeline
        id: test
        env:
          PYTHONUNBUFFERED: '1'
          PYTEST_CURRENT_TEST: '1'
          CI: 'true'
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          python -m src.pipelines.test_pipeline \
            --input test-type="all" \
            --input coverage-threshold="${{ inputs.coverage-threshold || '80' }}" \
            --input run-unit-tests="true" \
            --input run-integration-tests="${{ inputs.run-tests == 'true' }}" \
            --input upload-reports="true"
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: |
            test-reports/
            coverage-reports/
          retention-days: 30
  
  # 第三个作业：汇总结果（依赖于测试）
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build, test]  # 依赖构建和测试
    if: always()  # 即使前面的作业失败也执行
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: artifacts/
      
      - name: Download test reports
        uses: actions/download-artifact@v3
        with:
          name: test-reports
          path: test-reports/
      
      - name: Generate summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ Build: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Test: Success" >> $GITHUB_STEP_SUMMARY
            echo "Coverage: ${{ needs.test.outputs.coverage-percent }}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Set final status
        run: |
          if [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

